# ジョーカー入りポーカーのハンド判定

ジョーカーがカードの中に入ることで、ハンドの判定が一気に複雑になります。

ジョーカーなしのハンド判定方法は [別記事](p19.md)を参照してもらうとして、ジョーカーを加えた場合どのように対処すれば良いかを検討します。

## 方法1: 総当たり

ジョーカーはどのようなカードにも変化するカードと考えられます。なので、ジョーカーに当たるカードを残り52枚のカードに置き換えて52通りの判定を行い、最も強いハンドを答えとすればOKです。

## 方法2: 個別の条件に対応する

方法1はスマートな方法ではありません。個別にジョーカーを含めたクールな判定処理を作れないでしょうか。検討してみます。

ここからは集合や集計を伴う関数が使えることを前提としたアルゴリズムとなります。中級者向けです。

### ペア数

ランクの配列から、(ランク, ランクごとのカード枚数)というタプルを作成します。この際ジョーカーはカウントの対象外です。
例として、[ 1 1 4 8 0 ]というランクの配列があったとします（0はジョーカー）。この場合、以下のタプルの組が作成できます。

```
(1,2), (4,1), (8,1)
```
ジョーカーはランク的には1,4,8のどれかに変身できます。つまり、ランクごとのカード枚数が1のランクに化ければペア数が1増えます。よって、ジョーカーを含むカードセットのペア数は`通常計算のペア数+1`となります。
この計算は例外があり、ジョーカー以外の4枚のカードが同じランクであればペア数は1のままになりますが、最後のハンドの判定には影響しないので考慮しなくても問題ありません。

### カインド数

カインド数の計算はペア数よりも単純で、単に`通常計算のカインド数+1`でOKです。

### フラッシュ状態

フラッシュ状態の計算も単純で、ジョーカーを除いた残り4枚のスートが同じであればフラッシュ状態です。

### ストレート状態

最も計算上ややこしいのがストレート状態の判定です。

まずはジョーカーを除いた4枚分のランク配列を複製します。これは通常計算と同じくランク配列に破壊的変更を加える必要があるためです。
また、通常計算と同じく、ランクに1がある場合は配列に14を追加しましょう。

次にランク配列を**降順で**ソートし、先頭から通常計算と同様にi番目とi+1番目の要素の差が1かどうかをチェックしていきます。
この時、4つの要素が全て順列であればジョーカーがどのような状態でもストレート状態として確定できます。

もしi番目とi+1番目の要素の差が1でない場合、i番目のランクに1を減算した要素を配列に新たに加え、ソートしたのちにもう一度最初から判定をやり直します。この加えたランクがジョーカーのカードに相当します。今度は途中で差が1でない要素が出てきても停止しません。

### 降順ソートでチェックする理由

一言で言うと、こちらも「K -> A」対策です。

昇順でソートしても大部分のパターンで正しく判定できますが、唯一[ 10 J Q K A ]というパターンでJ,Q,Kのどれかがジョーカーに置き換わる、というパターンだけ正しく判定ができません。
例えば[ 10 J Joker K A ] というパターンの場合、セオリー通り14を加えると [ 1 10 11 13 14 ]という配列を走査することになります。

要素0番目と1番目の数値差がいきなり1ではないので、記載したアルゴリズム通り"2"を加えて[ 1 2 10 11 13 14 ]をチェックしてもストレートと判定できません。

ここで、最初の配列を降順にソートすると [14 13 11 10 1]となり、先頭から順番に要素値の差をチェックすると13と11の間でジョーカーの挿入(12)が発生し、配列が[14 13 12 11 10 1] となります。

こうすることにより14〜10の部分でストレート判定が正しく行われます。

ジョーカーなしの場合、ソート順は昇順でも降順でも判定結果は変わらないので通常の判定アルゴリズムも降順ソートで行った方が両者のロジックを共通化できてよりスマートなアルゴリズムになるでしょう。

## ハンドの判定

ハンドの判定自体はジョーカーなしの場合と同じです。